{% extends "base.html" %}

{% block title %}WhatsApp Mock API - Traffic Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
{% endblock %}

{% block content %}
<!-- Future Implementation -->
<!-- <div class="stats">
    <div class="stat-card">
        <div class="stat-number">{{ total_requests }}</div>
        <div class="stat-label">Total Requests</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ unique_hosts }}</div>
        <div class="stat-label">Unique Hosts</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ unique_paths }}</div>
        <div class="stat-label">Unique Paths</div>
    </div>
</div> -->

<div style="margin-bottom: 20px;">
    <button class="refresh-btn" onclick="location.reload()">üîÑ Refresh</button>
</div>

<!-- WhatsApp Credentials and Manual Message Sender -->
<div class="creds-message-sender">
    <div class="creds-section">
    <div class="request-card" >
        <form id="whatsappCredentials" style="display: grid; gap: 15px;">
            <!-- WhatsApp Credentials Section -->
            <div style="background: #FFF3E0; padding: 15px; border-radius: 8px; border: 2px solid #FF9800;">
                <h3 style="margin-bottom: 10px; color: #E65100;">üîê WhatsApp App Credentials (Hard-coded)</h3>
                <div style="display: grid; gap: 10px; font-family: 'Courier New', monospace; font-size: 13px;">
                    <div
                        style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 4px;">
                        <span style="font-weight: bold;">Phone Number ID:</span>
                        <span style="color: #2196F3;">{{ mock_phone_number_id }}</span>
                    </div>
                    <div
                        style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 4px;">
                        <span style="font-weight: bold;">App ID:</span>
                        <span style="color: #2196F3;">{{ mock_app_id }}</span>
                    </div>
                    <div
                        style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 4px;">
                        <span style="font-weight: bold;">App Secret:</span>
                        <span style="color: #2196F3;">{{ mock_app_secret }}</span>
                    </div>
                    <div
                        style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 4px;">
                        <span style="font-weight: bold;">WABA ID:</span>
                        <span style="color: #2196F3;">{{ mock_waba_id }}</span>
                    </div>
                    <div
                        style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 4px;">
                        <span style="font-weight: bold;">Access Token:</span>
                        <span style="color: #2196F3;">{{ mock_access_token }}</span>
                    </div>
                    <div
                        style="display: flex; justify-content: space-between; padding: 8px; background: white; border-radius: 4px;">
                        <span style="font-weight: bold;">Current Webhook Token:</span>
                        <span id="mock_whatsapp_webhook_access_token" style="color: #2196F3;">{{ mock_webhook_token
                            }}</span>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <input id="whatsapp_webhook_token" type="text" name="mock_webhook_token"
                            placeholder="Enter Webhook Token">
                        <button id="webhook-btn" class="webhook-btn" type="button">Set Webhook</button>
                    </div>
                    <div
                        style="padding: 8px; background: #FFECB3; border-radius: 4px; text-align: center; font-size: 11px;">
                        üí° To change these values, edit <strong>webhook/config.py</strong>
                    </div>
                </div>
            </div>
    </div>
    </div>
    <div class="manual-message-sender">
        <h3 style="margin-bottom: 10px; color: rgb(252, 0, 63);">üì± Send Manual Webhook Message</h3>
        <form>
            <label for="number">From Phone Number: <input type="text" id="number" name="number"></label><br>
            <label for="message">Message</label>
            <textarea id="message" name="message" rows="5" cols="40"></textarea>
            <input id ="message-submit" type="submit" value="Submit" class="webhook-btn" style="margin-top: 10px; color: rgb(0, 55, 252);">
        </form>
    </div>
</div>

    <!-- Traffic Logs -->
    <div id="traffic-log-section">
        <h2 style="margin-bottom: 15px; color: #1364b5;">üìä Recent Traffic Logs</h2>
        <div id="traffic-logs"></div>
    </div>




    {% endblock %}

    {% block extra_js %}
    <script defer>

        // Auto-refresh only the traffic log section, not the whole page
        async function refreshTrafficLog() {
            try {
                const response = await fetch("/traffic-logs");
                const data = await response.json();
                // console.log(data);
                // console.log(Array.isArray(data), data);


                const container = document.getElementById('traffic-logs');
                container.innerHTML = "";
                data.forEach(log => {
                    const div = document.createElement('div');
                    div.className = 'request-card';
                    const methodClass = `method-${log.method}`;
                    let messageHTML = '';
                    const body = JSON.parse(log.body) || {};
                    if (body.type === 'template') {
                        console.log('template message', body);
                        messageHTML = `
                        <div class="message message-template">
                                    <div class="message-type"><strong>Type:</strong> ${body.type}</div>
                                    <div class="message-template-name"><strong>Template Name:</strong> ${body.template.name}</div>
                                    <div class="message-language"><strong>Language:</strong> ${body.template.language.code}</div>
                        </div>`;
                    } else if (body.type === 'text' && !body.manualSend) {
                        console.log('text message', body);
                        messageHTML = `
                        <div class="message message-text">
                                    <div class="message-type"><strong>Type:</strong> ${body.type}</div>
                                    <div class="message-text-body"><strong>From:</strong> <pre>${body.to}</pre></div>
                                    <div class="message-text-body"><strong>Message:</strong> <pre>${body.text.body}</pre></div>
                        </div>
                                    `;
                    } else if (body.manualSend)
                        messageHTML = `
                            <div class="message message-manual-send">
                                        <div class="message-type"><strong>Type:</strong> ${body.type}</div>
                                        <div class="message-text-body"><strong>Message:</strong> <pre>${body.message}</pre></div>
                            </div>
                                        `;
                    
                    else {
                        messageHTML = `<div class="message-unknown">Unknown message format</div>`;
                    }



                    div.innerHTML = `
                        <div class="call-card">
                            <div class="call">
                                <div class="timestamp"><strong>Time:</strong> ${log.timestamp}</div>
                                <div class="host"><strong>Host:</strong> ${log.host}</div>
                                <div class="url"><strong>URL:</strong> ${log.url}</div>
                                <div class="path"><strong>Path:</strong> ${log.path}</div>
                                <div class="${methodClass}"><strong>Method:</strong> ${log.method}</div>
                                <div class="status"><strong>Status:</strong> ${log.status}</div>
                                
                                <div><strong>Headers:</strong> 
                                    ${log.headers.Accept ? `<div class="header-item"><strong>Accept:</strong> ${log.headers.Accept}</div>` : ''}
                                    ${log.headers['Content-Type'] ? `<div class="header-item"><strong>Content-Type:</strong> ${log.headers['Content-Type']}</div>` : ''}
                                    ${log.headers['User-Agent'] ? `<div class="header-item"><strong>User-Agent:</strong> ${log.headers['User-Agent']}</div>` : ''}
                                    ${log.headers['Accept-Encoding'] ? `<div class="header-item"><strong>Accept-Encoding:</strong> ${log.headers['Accept-Encoding']}</div>` : ''}
                                </div>
                            </div>
                            <div class="divider"></div>
                                <div class="message">
                                    ${messageHTML}
                                </div>


                        </div>
                    `;
                    container.appendChild(div);
                })


            } catch (error) {
                console.error('Failed to refresh traffic log:', error);
            }

            setTimeout(refreshTrafficLog, 1000);
        }

        // Start auto-refresh after 1 second
        setTimeout(refreshTrafficLog, 1000);

        async function setWhatsAppWebhook() {
            const tokenInput = document.querySelector('#whatsapp_webhook_token');
            try {
                const response = await fetch("/set-odoo-whatsapp-webhook", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        webhook_token: tokenInput.value
                    })
                });
                const data = await response.json();
                document.getElementById('mock_whatsapp_webhook_access_token').textContent = data.webhook_token;
            } catch (error) {
                console.error('Failed to refresh traffic log:', error);
            }
        };
        document.getElementById('webhook-btn').addEventListener('click', (e) => {
            e.preventDefault();
            setWhatsAppWebhook();
        });

        async function sendManualWebhookMessage(event) {
            console.log('Sending manual webhook message...');
            const numberInput = document.getElementById('number');
            const messageInput = document.getElementById('message');
            try {
                const response = await fetch("/send-manual-webhook-message", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        from_phone_number: numberInput.value,
                        message: messageInput.value,
                        type: 'text',
                        manualSend: true
                    })
                });
                const data = await response.json();
                alert('Message sent successfully!');
                numberInput.value = '';
                messageInput.value = '';
            } catch (error) {
                console.error('Failed to send manual webhook message:', error);
            }
        };
        document.getElementById('message-submit').addEventListener('click', (e) => {
            e.preventDefault();
            sendManualWebhookMessage(e);
        });

    </script>

    {% endblock %}